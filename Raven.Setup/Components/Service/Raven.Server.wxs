<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
		 xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension">
	<Fragment>
		<?include ServiceSettings.wxi ?>
		
		<DirectoryRef Id='INSTALLFOLDER'>
			<Component Id="Raven.Server" Guid="7C607936-122E-460B-B6E8-F9050338847C">
				<File Id='Nlog.dll_Service' Name='Nlog.dll' DiskId='1' Source='$(var.Raven.Server.TargetDir)\Nlog.dll' />
				<File Id="Raven.Server" Name='$(var.Raven.Server.ProjectName).exe' DiskId='1' Source='$(var.Raven.Server.TargetPath)' KeyPath='yes' />
				<fire:FirewallException Id="Firewall.Raven.Server" Name="RavenDB - Service - [SERVICE_PORT]" Port="[SERVICE_PORT]"
																Protocol="tcp" Scope="any" IgnoreFailure="yes" Program="System" />
			</Component>

			<Component Id="PersistServiceValues" Guid="EF416252-3A05-4290-AF68-FEE59B756198" >
				<RegistryKey Root="HKLM" Key="Software\[Manufacturer]\[ProductName]">
					<RegistryValue Type="string" Name="SERVICE_NAME" Value="[SERVICE_NAME]" />
					<RegistryValue Type="string" Name="SERVICE_PORT" Value="[SERVICE_PORT]" />
				</RegistryKey>
			</Component>

			<Component Id="Raven.Server.Config.File" Guid="2DBA3C81-E507-4811-90A0-D3807AC40C9C" Permanent="yes" NeverOverwrite="yes">
				<File Id='Raven.Server.exe.config' Name='Raven.Server.exe.config' DiskId='1' Source='$(var.SolutionDir)\DefaultConfigs\RavenDb.exe.config' KeyPath='yes' />
				<util:XmlFile Id="ModifyPort"
                 Action="setValue"
                 Permanent="yes"
                 ElementPath="/configuration/appSettings/add[\[]@key='Raven/Port'[\]]"
                 Name="value"
                 File="[#Raven.Server.exe.config]"
                 Value="[SERVICE_PORT]"
                 SelectionLanguage="XSLPattern"
                 Sequence="1" />
				<util:XmlFile Id="SetDataDir"
						 Action="setValue"
						 Permanent="yes"
						 ElementPath="/configuration/appSettings/add[\[]@key='Raven/DataDir'[\]]"
						 Name="value"
						 File="[#Raven.Server.exe.config]"
						 Value="[RAVEN_DATA_DIR]"
						 SelectionLanguage="XSLPattern"
						 Sequence="5" />
				<util:XmlFile Id="AddEmptyIndexStoragePathSetting"
						 Action="createElement"
						 Permanent="yes"
						 ElementPath="/configuration/appSettings"
						 Name="add"
						 File="[#Raven.Server.exe.config]"
						 SelectionLanguage="XSLPattern"
						 Sequence="6" />
				<util:XmlFile Id="AddIndexStoragePath"
						 Action="setValue"
						 Permanent="yes"
						 ElementPath="/configuration/appSettings/add[\[]not(@key)[\]] "
						 Name="key"
						 Value="Raven/IndexStoragePath"
						 File="[#Raven.Server.exe.config]"
						 SelectionLanguage="XSLPattern"
						 Sequence="7" />
				<util:XmlFile Id="SetIndexStoragePath"
						 Action="setValue"
						 Permanent="yes"
						 ElementPath="/configuration/appSettings/add[\[]@key='Raven/IndexStoragePath'[\]]"
						 Name="value"
							 File="[#Raven.Server.exe.config]"
						 Value="[RAVEN_INDEX_DIR]"
						 SelectionLanguage="XSLPattern"
						 Sequence="8" />
			</Component>
    </DirectoryRef>
	</Fragment>
</Wix>
